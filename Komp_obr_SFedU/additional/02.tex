\documentclass[10pt,pdf,hyperref,aspectratio=169]{beamer}
\hypersetup{pdfpagemode=FullScreen}
\usepackage{lect}
\usepackage{xspace}

\title[Обработка FITS-файлов. Лекциия 2.]{Компьютерная обработка астрономических изображений}
\subtitle{Фотометрия. Астрометрия. }
\date{}

\def\e{{\overline{e}}}
\def\SNR{\ensuremath{\mathrm{SNR}}\xspace}

\begin{document}
% Титул
\begin{frame}{}
\maketitle
\end{frame}
% Содержание
\begin{frame}{}
\tableofcontents
\end{frame}

\section{Фотометрия}
\begin{frame}{Фотометрия}
\begin{columns}
\column{0.45\textwidth}
\begin{block}{Принципы фотометрии}
Распределение света от звезды между пикселями неоднородное, зашумленное.
Для измерения полного потока от звезды, необходимо:
\begin{itemize}
\item определить положение звезды на изображении;
\item при помощи маски выбрать те пиксели, которые принадлежат изображению именно этой звезды;
\item просуммировать сигнал за вычетом фона.
\end{itemize}
\end{block}
\column{0.45\textwidth}
\begin{block}{Центроид}
$$\mean{x}=\frac{\sum x_i I_i}{\sum I_i},\quad \mean{y}=\frac{\sum y_i I_i}{\sum I_i}, \quad
I_i = S_i - B.$$

Задача детектирования звезд на изображении. Простейший способ построения маски бинаризацией по
порогу в общем случае не годится. Дифференциальные методы: лапласиан гауссианы и т.п.
Морфологические операции\dots
\end{block}
\end{columns}
\end{frame}

\subsection{Апертурная фотометрия}
\begin{frame}
\begin{block}{Апертурная фотометрия}
Проблема: определить радиусы апертур (звезды и фона).
\end{block}
\img[0.9]{apert}
\end{frame}

\begin{blueframe}
%\vspace*{-1em}
\begin{block}{Коррекция апертуры}
    Почему изображение яркой звезды шире: несмотря на совершенно одинаковую PSF у обеих
    звезд, при сечении одинаковым порогом яркая звезда всегда <<больше>>. Увеличение апертуры \Arr
    увеличение шумов, необходимо использовать как можно меньшую апертуру.
    $$\Delta_N^{bright} = m(N\cdot \FWHM) - m(1\cdot\FWHM)\quad\Arr\quad
    m^{faint} = m(1\cdot\FWHM) + \Delta_N^{bright},$$
    $m(x)$~-- звездная величина на апертуре~$x$.
\end{block}\vspace*{-1em}
\img[0.45]{fwhm}
\end{blueframe}

\begin{frame}
\only<1>{
\begin{columns}
\column{0.45\textwidth}
\img{starphotom}
\column{0.52\textwidth}
\begin{block}{Модель апертурной фотометрии}
Параметры звезды: уровень сигнала, координаты центра, полуширина.

Параметры фона: средний уровень сигнала, $B$.

Параметры светоприемника: квантовая эффективность, шумы.

Радиусы апертур: $r_1$, $r_2$, $r_3$.

$$m = \C -2.5\lg(N_{star}-N_{sky}).$$

Наиболее оптимальным вариантом будет выбрать $2\cdot r_1$~равным средней по изображению FWHM звезд.
В  любом случае, потребуется апертурная коррекция результатов.
\end{block}
\end{columns}
}\only<2>{
\begin{columns}
\column{0.33\textwidth}
\img{photcurves}
\column{0.62\textwidth}
\begin{block}{}
PASP, 1989 Steve B.~Howell: <<Two-dimensional aperture photometry: signal-to-noise ratio of
point-source observations and optimal data-extraction techniques>>.

Масштаб: $0.4''/$пиксель.
Звездные (инструментальные) величины: 14.2 (квадрат), 14.5 (треугольник), 16.1 (пустой квадрат). По
б) видно, что у слабой звезды плохо выраженные крылья, что резко уменьшает точность при увеличении
апертуры. Наибольшие \SNR и точность достигаются при радиусе апертуры примерно равном FWHM/2.
\end{block}
\end{columns}
}\only<3>{\vspace*{-1em}
\begin{columns}
\column{0.37\textwidth}
\img{growth_curves}
\column{0.55\textwidth}
\begin{block}{Кривые роста}
Позволяют определить оптимальный радиус. На а) по вертикали отложена сумма сигнала в данной
апертуре, деленная на ее площадь. Как только сигнал сравнивается с фоном, кривая идет вниз.
На б) эти же величины в логарифмической шкале.

По интегральной кривой роста (не нормированной на количество пикселей) можно определить вид
наиболее подходящей аппроксимирующей функции. Например, интегральные функции для одномерной
гауссианы и моффата:
$$G(r)= 1 - \exp \Bigl(-\frac{r^2}{2\sigma^2}\Bigr),\quad \textrm{FWHM}=2\sigma\sqrt{2\ln2};$$
$$M(r)= 1 - \Bigl(1+\frac{r^2}{\alpha^2}\Bigr)^{1-\beta},\quad \textrm{FWHM}=2\alpha
\sqrt{2^{1/\beta}-1}.$$
\end{block}
\end{columns}
}

\end{frame}

\begin{frame}
\begin{block}{Основные выражения}
$S = F+B+Q+E$, где $S$~-- накопленный сигнал, $F$~-- сигнал от звезды, $B$~-- фон, $Q$~-- темновой
ток, $E$~-- bias.

Суммарный сигнал от звезды: $F_\Sigma = \sum F_i=\sum(S_i-[B_i+Q_i+E_i])$.

Шум: $\sigma^2=F_\Sigma + N(\mean{B}+\mean{Q}+\sigma^2_{RO})+\sigma^2_{sky}$, $N$~-- количество
пикселей маски звезды, $\sigma^2_{RO}$~-- шум считывания. Первый член отражает зависимость
пуассонова шума от уровня сигнала. $\sigma^2_{sky}=N(\mean{B}+\mean{Q}+\sigma^2_{RO})/N_{sky}$,
$N_{sky}$~-- количество пикселей в маске фона.

$\SNR=F_\Sigma/\sigma$. Чем слабее звезда, чем больше уровень фона, чем больше~$N$ и
меньше~$N_{sky}$, тем худшим будет \SNR.

\vskip6pt

Крайние случаи: <<source limited>> и <<detector limited>>. SL: доминирует пуассонов шум
фотонов, т.е. $\SNR\approx N_\star/\sqrt{N_\star}=\sqrt{N_\star}\propto\sqrt{t_{exp}}$.
DL: доминирует шум считывания светоприемника $\SNR\approx N_\star/\sqrt{N\sigma^2_{RO}}\propto
N_\star\propto t_{exp}$.
\end{block}
\end{frame}

\begin{frame}
\only<1>{
\begin{columns}
\column{0.57\textwidth}
\img{starprofile}
\column{0.4\textwidth}
\begin{block}{Профили звезд}
Средний по изображению профиль позволяет оценить радиусы апертур. Также поможет при апертурной
коррекции.

Ошибка определения звездной величины: $\sigma_m=1.0857/\SNR$.
\end{block}
\end{columns}}
\only<2>{
\begin{columns}\column{0.6\textwidth}
\img[0.9]{Z1000frame}
\column{0.35\textwidth}
\begin{block}{}
Кадр с фотометра-поляриметра MMPP, Zeiss-1000, САО РАН.
\end{block}
\end{columns}
}
\end{frame}

\subsection{PSF--фотометрия}
\begin{frame}{PSF--фотометрия (ФРТ)}
\only<1>{\vspace*{-1em}
\begin{columns}\column{0.6\textwidth}
\img[0.9]{roboframe}
\column{0.35\textwidth}
\begin{block}{}
0.5-метровый телескоп Astrosib, фокус Ньютона, САО РАН. Поле примерно $1.5\degr\times1.5\degr$.
\end{block}
\end{columns}
}
\only<2>{
\vspace*{-1em}
\img{roboframepart}\vspace*{-1em}
\begin{block}{}
В тесных звездных полях невозможно простейшим способом выделить круговую апертуру фона около
звезды. Вариант 1: по маске исключить звезды и (например, аппроксимацией B-сплайнами) точно
выделить фон. Вариант 2: использовать PSF-фотометрию (осложняется на широких полях, т.к. PSF сильно
меняется по полю).
\end{block}
}\only<3>{
\begin{block}{}
    Аппроксимация изображений звезд одной из функций фитирования. В общем случае для ускорения
    задачи
    необходимо ограничить количество степеней свободы (например, заданием областей положения
    максимумов), особенно если звезд в кадре тысячи или даже десятки тысяч.
\end{block}
\img[0.85]{fitting}
}
\end{frame}

\begin{frame}{}
\only<1>{
\begin{columns}\column{0.6\textwidth}
\img{airy}
\column{0.4\textwidth}
\begin{block}{}
Диск Эйри~--- идеальная ФРТ вне атмосферы.
Эйри (сплошная) и гауссиана (пунктир).
\end{block}
\begin{light}\img{Airy_vs_gaus}\end{light}
\end{columns}
}\only<2>{
\begin{columns}\column{0.5\textwidth}
\img{moffat}
\column{0.45\textwidth}
\begin{block}{}
Спеклы. Распределения Гаусса (малые телескопы) и Моффата (большие)~--- близкие к идеальной ФРТ на
наземных телескопах.

$$G(x,y) = \C\e^{-g},\quad g=\frac{(x-x_0)^2}{2\sigma^2_x}+\frac{(y-y_0)^2}{2\sigma^2_y}.$$
$$M(x,y) = \C\left(1+\frac{(x-x_0)^2+(y-y_0)^2}{\alpha^2}\right)^\beta,$$
$\alpha>0$~-- масштаб, $\beta>1$~-- форма.

Проблема: аберрации, вариация ФРТ по кадру.
\end{block}
\end{columns}
}
\end{frame}

\subsection{Дифференциальная фотометрия}
\begin{frame}{}
Дифференциальная фотометрия
\img[0.75]{difff}
\end{frame}

\subsection{Абсолютная фотометрия}
\begin{frame}{}
\only<1>{
\begin{block}{Абсолютная фотометрия}
Если в кадре нет стандартов:
\begin{itemize}
\item провести как можно больше измерений различных стандартов в нужных фильтрах;
\item диапазон воздушных масс стандартов должен перекрывать диапазон воздушных масс объектов;
\item цвета стандартов не должны сильно отличаться от цветов объектов;
\item по проведенным наблюдениям стандартов необходимо получить коэффициенты уравнений
преобразования от инструментальных величин к стандартным;
\item используя уравнения преобразований, преобразовать инструментальные величины объектов к
стандартным.

\vskip8pt

Измерения стандартов необходимо производить с наибольшим \SNR. Пусть фон неба~--- 100~фотонов на
пиксель в секунду. $\sigma_{sky}=\sqrt{100}=10$. Если мы измеряем объект $N_\star=10$~ф/п/с, то
$\SNR=1$, т.е. наши измерения имеют уровень в~$1\sigma$. При $N_\star=100$~ф/п/с $\SNR=10$, уровень
измерений~--- $10\sigma$, что достаточно хорошо для научных измерений, но еще недостаточно для
измерений стандартов (для них \SNR около тысячи и выше).
\end{itemize}
\end{block}
}\only<2>{
\begin{block}{Уравнения преобразований}
Пусть $B,V,R,I$~--- звездные величины стандартов, $b,v,r,i$~--- инструментальные, $X$~--- воздушная
масса. Тогда получим наборы коэффициентов преобразования цветов, $T$; коэффициентов атмосферной
экстинкции, $K$; нуль-пунктов, $Z$. Например, для цветов:
$$B-V = (b-v)T_{bv} + K_{bv}X + Z_{bv},$$
$$V-R = (v-r)T_{vr} + K_{vr}X + Z_{vr},$$
$$R-I = (r-i)T_{ri} + K_{ri}X + Z_{ri}\ldots$$
Для полос:
$$B = bT_b + K_bX + Z_b,$$
$$V = vT_v + K_vX + Z_v \ldots$$
\end{block}
}
\end{frame}

\section{Астрометрия}
\subsection{SExtractor}
\begin{frame}[fragile]{SExtractor}
SExtractor (Source-Extractor)\footnote{\url{https://sextractor.readthedocs.io/}}~--- утилита поиска
объектов на астрономическом изображении (Emmanuel Bertin). Позволяет
выявлять звездоподобные и протяженные объекты, проводить простую фотометрию. Работает с умеренно
переполненными полями. Синтаксис:
\begin{verbatim}
sex Image1 [Image2] -c configuration-file [-Parameter1 Value1 -Parameter2 Value2 ...]
\end{verbatim}
Конфигурация по умолчанию: \verb'sex -d > default.sex' (или \t{dd} для более интенсивного дампа).
Простая команда \t{sex} выведет краткую (очень) справку.

Измерения: барицентры по изофотам, апертурная фотометрия, аппроксимация модельной функции для
поиска источников.

Обязательно к прочтению: <<Source Extractor for Dummies>> by Dr.~Benne W.~Holverda.
\end{frame}

\begin{frame}
\begin{columns}
\column{0.45\textwidth}
\vspace*{-1em}
\img{sexalgo}
\column{0.5\textwidth}
\begin{block}{Алгоритм}
\begin{itemize}
\item Измерение фона и его RMS.
\item Извлечение фона.
\item Применение заданных фильтров.
\item Поиск объектов (по порогу).
\item Разделение <<слившихся>> объектов.
\item Измерение их форм и положений.
\item Выделение индивидуальных объектов.
\item Фотометрия.
\item Классификация (звезда или нет?).
\item Формирование выходных файлов.
\end{itemize}
\end{block}
\end{columns}
\end{frame}

\subsection{Астрометрия}
\begin{frame}{Астрометрия}
\begin{columns}
\column{0.57\textwidth}
\img{diffastrometry}
\column{0.4\textwidth}
\begin{block}{}
Астрометрия позволяет измерить точные координаты звезд на небе, а также определить их параллаксы и
собственные движения. Первый каталог~--- Иппарх, точность не выше~$1\degr$.
XVI~век~--- Тихо Браге, $1'$. XVII~век~-- точность в единицы секунд в очень малом поле.
Параллаксы до Бесселя~--- 0!
Микросекундной точности достиг запущенный в 1989\,г. космический телескоп HIPPARCOS.

Точность GAIA~--- $0.00002''$ ($20\mu as$)~--- толщина человеческого волоса с расстояния в 1000\,км!
\end{block}
\end{columns}
\end{frame}

\begin{frame}{}
\begin{block}{Каталоги}
\begin{enumerate}
\item \textbf{HIPPARCOS}~--- звезды до $m_V=7.3^m$, точность астрометрии до $1\div3\,$mas
(J1991.25). Полосы B и~V для 188~тыс звезд.  Собственные движения (PM) $\sim1\div2\,$mas/y.
\item \textbf{TYCHO-2}~--- до $m_V=11^m$, точность $10\div100\,$mas. 2.5~млн. звезд, PM
$\sim1\div3\,$mas/y.
\item \textbf{USNO B 1.0}~--- до $m_V=21^m$, фотометрический каталог с точностью до $0^m.3$. Свыше
миллиарда объектов.
\item \textbf{2MASS}~--- 470~миллионов объектов, точность до $70\,$mas. Полосы J, H и K.  Без PM.
\item \textbf{SDSS}~--- фотометрический каталог четверти неба в пяти фильтрах, 287~миллионов
объектов. Включает спектры галактик и квазаров.

Библиотеки SOFA и ERFA (одно и то же с разными лицензиями) позволяют преобразовывать координаты
между эпохами и вычислять видимое место.
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{}
\only<1>{
\vspace*{-1em}
\begin{columns}
\column{0.5\textwidth}
\img{WCSfits}
\column{0.48\textwidth}
\begin{block}{WCS}
WCS~--- World Coordinate System. ICRS~--- International Celestial Reference System (привязка к
барицентру Солнечной системы).
Ключевые слова WCS в FITS--шапке позволяют осуществить однозначную привязку пиксельных координат к
мировым (и обратно). Для линейных преобразований: \textbf{CTYPEi}~-- тип оси, \textbf{CRPIXi}~--
опорный пиксель (в пиксельных координатах), \textbf{CRVALi}~-- значение мировых координат в этом
пикселе (1~-- $\alpha$, 2~-- $\delta$), \textbf{CDELTi}~-- масштаб по соответствующей оси,
\textbf{CROTA2}~-- угол поворота, \textbf{CDi\_j}~-- матрица коэффициентов, описывающих поворот
осей и масштаб, \textbf{CUNITi}~-- единицы измерения по данной оси.
\end{block}
\end{columns}
}\only<2>{
\begin{columns}
\column{0.47\textwidth}
\begin{block}{Простейший случай}
Обозначим \textbf{CRPIX}~-- $p$, \textbf{CRVAL}~-- $v$, \textbf{CDELT}~-- $d$, \textbf{CROTA2}~--
$r$, \textbf{CD}~-- $c$, тогда
$$\begin{cases}
\alpha = d_1(x-p_1)\cos r - d_2(y-p_2)\sin r,\\
\delta = d_1(x-p_1)\sin r + d_2(y-p_2)\cos r;\end{cases}$$

$$\begin{cases}\alpha = c_{11}(x-p_1) - c_{12}(y-p_2),\\
\delta = c_{21}(x-p_1) + c_{22}(y-p_2).\end{cases}$$

$$\begin{pmatrix}c_{11} & c_{12}\\ c_{21} & c_{22} \end{pmatrix} =
\begin{pmatrix} d_1\cos r &-d_2\sin r\\ d_1\sin r & d_2\cos r\end{pmatrix}
$$
\end{block}
\column{0.47\textwidth}
\begin{block}{}
Пакет \t{wcstools}. Утилиты \t{xy2sky} и \t{sky2xy}. Полный список: \t{man wcstools} или
утилита \t{wcstools}. \t{imcat} отображает объекты из каталогов (каталоги необходимо сохранить в
поддиректории \t{/data/astrocat/}). \t{imhead}~-- отобразить шапку. И множество других утилит для
работы с WCS и шапкой файлов.

Утилита \t{ds9} имеет возможность отображать объекты из различных каталогов.
\end{block}
\end{columns}
}
\end{frame}

\subsection{astrometry.net}
\begin{frame}{astrometry.net}
\only<1>{
\begin{block}{}
Построение базы данных.
\begin{enumerate}
\item Используя астрометрические каталоги построить базу данных особого вида признаков (хешей).
\item Хеши должны быть масштабируемыми для ускорения поиска по разным изображениям.
\item Функция сравнения хешей должна учитывать погрешности каталогов, шум и аберрации изображений.
\item На изображениях вполне могут находиться звезды, которых нет в каталогах и обратно: часть
звезд может отсутствовать.
\item Функция сравнения хешей должна быть устойчивой и однозначной.
\item Вначале на снимке ищутся эти самые признаки, по ним определяются масштаб, ориентация и
координаты изображения. Далее происходит собственно астрометрия.
\savei
\end{enumerate}
\end{block}
}\only<2>{
\begin{enumerate}
\conti
\item Хешами служит набор чисел, определяющих относительные координаты внутренних двух звезд внутри
квадрата, сформированного внешними двумя. В результате образуется четырехмерный код,
характеризующий данный признак. Зеркалирование изображения приводит к зеркалированию кода, приводя
к вырождению признака относительно зеркалирования, однако, хеш инвариантен к масштабированию,
переносу и повороту.
\item Для равномерно распределенных в пространстве звезд хеши равномерно распределены в 4D.
\item Хеш строится лишь по таким четверкам примерно одинаковой яркости, где~C и~D внутри круга AB.
\item Каталоги: USNO-B (миллиард объектов) и TYCHO-2 (2.5~млн ярчайших звезд).
\item Небесная сфера последовательно масштабируется, для каждого масштаба отбирается несколько
ярчайших признаков соответствующих масштабу размеров.
\item Объекты каждой ячейки кодируются и образуют четырехмерное дерево.
\end{enumerate}
}\only<3>{\img[0.6]{astrometrynet}
}\only<4>{
Процедура астрометрии.
\begin{enumerate}
\item Идентификация объектов на изображении и определение координат звезд (например, используя
SExtractor).
\item Обнаружение всех подходящих квадратов и вычисление соответствующих им хешей.
\item Поиск совпадений (с заданной точностью) в базе данных.
\item Если пара квадратов отождествлена, по остальным проводится уточнение ориентации положения и
масштаба кадра.
\item Если отождествлен лишь один квадрат, поиск считается неудачным.
\item Для ускорения поиска желательно указать диапазон масштабов изображения, примерные координаты
центра и допуск на радиус поиска.
\end{enumerate}
}
\end{frame}

\begin{frame}{Спасибо за внимание!}
\centering
\begin{minipage}{5cm}
\begin{block}{mailto}
eddy@sao.ru\\
edward.emelianoff@gmail.com
\end{block}\end{minipage}
\end{frame}
\end{document}
