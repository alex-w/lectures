\documentclass[10pt,pdf,hyperref,aspectratio=169]{beamer}
\hypersetup{pdfpagemode=FullScreen}
\usepackage{lect}

\title[Обработка FITS-файлов. Лекциия 1.]{Компьютерная обработка астрономических изображений}
\subtitle{Получение изображений на ПЗС, базовые манипуляции. Фотометрия. Астрометрия.}
\date{}

\def\e{{\overline{e}}}

\begin{document}
% Титул
\begin{frame}{}
\maketitle
\end{frame}
% Содержание
\begin{frame}{}
\tableofcontents[hideallsubsections]
\end{frame}

\section{ПЗС светоприемники}
\begin{frame}{ПЗС}
\vspace*{-1.5em}
\begin{columns}
\column{0.43\textwidth}
\img{ccdintro}
\column{0.55\textwidth}
\begin{block}{}
    1969, Уиллард Бойл и Джордж Смит, лаборатории Белла.

    1975 "--- первая ПЗС 100x100 (Steven Sasson, Kodak).

    1976 "--- запуск спутника--шпиона с ПЗС 800x800.
\end{block}
\img[0.7]{ccdanatomy}
\end{columns}
\end{frame}

\begin{frame}{}
    \only<1>{\begin{block}{Тактирование ПЗС}Трехфазное\end{block} \img[0.7]{3phase}}
    \only<2>{\begin{block}{Тактирование ПЗС}Двухфазное\end{block} \img[0.7]{2phase}}
\end{frame}

\section{Характеристики детекторов}
\subsection{Характеристики детекторов}
\begin{frame}{Характеристики детекторов}
    \begin{block}{}
        Размер, количество пикселей (каналов), чувствительность в зависимости от длины волны
        (квантовая эффективность) и доступный спектральный диапазон, глубина потенциальной ямы,
        динамический диапазон, линейность, временн\'ое разрешение, возможность  работы в режиме
        счета фотонов, шумовые характеристики (темновой, считывания), стабильность, цена.
    \end{block}
    \begin{block}{Эволюция детекторов}
        Историческая эволюция: глаз \Arr фотопластинка \Arr одноканальные фотоэлектрические
        приемники \Arr сканеры фотопластинок \Arr телевизионные сканеры \Arr полупроводниковые
        устройства (фотодиоды, ПЗС, композитные ИК приемники, болометры, лавинные фотодиоды, КМОП)
        \Arr устройства, измеряющие энергию фотона (STJ "--- на сверхпроводящих туннельных
        переходах, transition-edge sensor "--- повышение сопротивления свехпроводящего перехода).
    \end{block}
\end{frame}

\begin{frame}{Квантовая эффективность ПЗС}
    \only<1>{QE "--- отношение количества падающих фотонов к детектируемым.\img[0.85]{QE_PTGrey}}
    \only<2>{\img[0.6]{quantumefficiencyfigure1}}
\end{frame}

\begin{frame}{Линейность}
    Линейность ПЗС-камеры Apogee Alta 16M-HC (Kodak KAF-16803).
    \img[0.5]{Apogee_linearity}
    $\pm0.5\%$  ($2000\div40000$ ADU); $\pm1.0\%$ ($0\div45000$ ADU).
\end{frame}

\begin{frame}{Динамический диапазон}
    \begin{columns}
    \col{0.4}\begin{block}{}
            Максимальный размах уровней сигнала, при котором он регистрируется без потерь.\\
            Идеал "--- бесконечный динамический диапазон.
        \end{block}
        \col{0.6}\img{bloomingfigure4}
    \end{columns}
\end{frame}

\begin{frame}{Пространственное разрешение}
    \begin{block}{}Степень детализации изображения зависит от условий наблюдения, оптики
    телескопа и прибора, размера пикселя.
    \end{block}
    \img[0.72]{digitalimagingfigure2}
\end{frame}

\begin{blueframe}{Выбор светоприемника под масштаб}
\vspace*{-0.8em}
\begin{block}{}\centering
    $5a\ge\Delta x \ge 2a,$ $S_{tel}=\dfrac{F_{tel}}{206265}\quad$.
    БТА: $1/S=8.6''/$мм, $\Delta x_{1''}=116.36\,$мкм

    $a_{opt}=23.3\,$мкм. Нужен редуктор $\sim2.5\,$раза!
    $m = \dfrac{S_{cam}}{S_{tel}}=\dfrac{F_{cam}}{F_{coll}}<1$
\end{block}
\img[0.9]{focal_reducer}
\end{blueframe}

\section{Шумы}
\begin{frame}{Шумы}\vspace*{-0.5em}
\only<1>{
\begin{columns}
\col{0.7}
    \img[0.9]{Kodak_dark}
\col{0.3}
\begin{block}{}
Выходной сигнал всегда отличается от входного: пуассонова статистика фотонов, фон
неба, тепловой (темновой) шум, космические частицы, шум считывания и т.п.

Темновой шум сильно зависит от температуры.
\end{block}\vspace*{-0.5em}
\end{columns}}
\only<2>{\img[0.55]{ccd_darkcur}}
\only<3>{
\begin{block}{}
    Если пуассонов шум фотонов плоского поля превышает шум считывания, гистограмма имеет почти
    гауссову
    форму.
    $$\sigma\ind{ADU}=\frac{\sqrt{\mean{F}\cdot G}}{G}$$
    $\sigma\ind{ADU}$~-- полуширина гистограммы плоского поля, $\mean F$~-- средний уровень
    плоского,
    $G$~-- gain (коэффициент преобразования фотоэлектронов в ADU).

    Два кадра bias ($B$) и плоского ($F$):
    $$
    G = \frac{(\mean{F_1}+\mean{F_2}) -
    (\mean{B_1}+\mean{B_2})}{\sigma^2_{F_1-F_2}-\sigma^2_{B_1-B_2}}
    $$
    Шум считывания:
    $$
    RN = \frac{G\cdot\sigma_{B_1-B_2}}{\sqrt2}
    $$
\end{block}}
\end{frame}

\begin{frame}{}
    \begin{block}{Коррелированная двойная выборка}
        \only<1>{Накопленный каждым пикселем заряд по линии зарядовой связи перемещается в выходной
        тракт,
            где преобразуется в напряжение. Перед считыванием очередного заряда тракт сбрасывается,
            что
            увеличивает шум считывания.}
        \only<2>{ДКВ вычисляет уровень полезного сигнала относительно смещения. Первая выборка
        снимается
            сразу после сброса выходного тракта ПЗС. Вторая~--- по окончании переноса очередного
            заряда.
            Реализуется при помощи усилителей <<выборка--удержание>>, sample-and-hold amplifier.
            Значительно
            снижает уровень коррелированных шумов.}
    \end{block}
    \only<1>{\img[0.5]{corrs1}}
    \only<2>{\img[0.5]{corrs2}}
\end{frame}

\begin{frame}{}
\begin{block}{Вкратце о ПЗС}
\begin{itemize}
    \item Для повышения эффективности толщина рабочего слоя ПЗС должна быть не больше подложки
    n-типа,
    back-illuminated. Усложнение техпроцесса, удорожание.
    \item Глубокое охлаждение чипа: при $-80\degr$C с ростом температуры на $\sim7\degr$C темновой
    шум
    увеличивается в два раза.
    \item Кремниевая подложка имеет красную границу на $\sim1.1\,$мкм, в ИК светоприемники с
    кремниевыми подложками не будут работать.
    \item Утончение чипа приводит к росту прозрачности для больших длин волн и появлению фрингов.
    \item Большой проблемой является растекание заряда с переэкспонированных пикселей.
    \item ПЗС невозможно оснастить <<электронным>> затвором, их затвор механический.
    \item Дефекты подложки приводят к появлению <<горячих>> и <<плохих>> пикселей.
    \item Постоянное воздействие космических частиц вызывает необратимую деградацию.
\end{itemize}
\end{block}
\end{frame}

\section{Первичная обработка снимков}
\begin{frame}{Первичная обработка снимков}
\begin{block}{}
\ж Квантовая эффективность\н: $\mathrm{QE} = N_\e/N_\gamma$. \ж Выходной сигнал:\н $S$ (ADU).
Коэффициент усиления (\ж gain\н): $\mathrm{gain}=N_\e/S$.
Уровень смещения (\ж bias\н)~--- инжектируемый заряд для вывода кривой чувствительности на линейный
участок \Arr $N_\e = N_{\e bias} + N_{\e object}$, $S = S_{bias} + S_{object}$.

Т.е. $N_\gamma=\mathrm{gain}\cdot S_{object}/\mathrm{QE}$.

\ж Шум считывания\н складывается из шумов переноса заряда и шума усилителя.

Кадр смещения, bias, получается для коррекции сигнала на инжектируемый нулевой заряд, позволяет
определить шум считывания. Для снижения
шумов рекомендуется получать медиану как можно большего количества кадров.

Темновой кадр, \ж dark\н, (с закрытой диафрагмой) содержит информацию о темновых шумах.

Плоское поле, \ж flat\н, необходимо для коррекции виньетирования и неоднородностей оптических
систем. Отражает попиксельную неоднородность чувствительности.

\ж Биннинг\н. Сложение происходит до АЦП, поэтому увеличивается полезный сигнал в N раз при том же
уровне шума, т.е. влияние шума считывания снижается. Увеличение скорости считывания и уровня
сигнала (но уменьшение разрешения).

\ж Overscan\н~--- служебная (не засвечиваемая) область ПЗС, позволяет грубо оценивать bias без
получения отдельного кадра.
\end{block}
\end{frame}

\begin{frame}
\begin{block}{Сигнал-шум}
    В общем случае
    $$\mathrm{SNR}=N_*\cdot\left[N_*+n_{pix}\Bigl(1+\cfrac{n_{pix}}{n_B}\Bigr)
    \bigl(N_S+N_D+N^2_R+G^2\sigma^2_f\bigr)\right]^{-1/2},
    $$
    $N_*$~-- количество фотонов от объекта; $n_{pix}$~-- количество пикселей для вычисления SNR;
    $n_B$~--
    количество пикселей для оценки фона; $N_S$~-- количество фоновых фотонов на пиксель; $N_D$~--
    количество
    темновых фотонов на пиксель; $N^2_R$~-- количество электронов на пиксель вследствие шума
    считывания; $G$~--
    gain; $\sigma_f\approx0.289$~-- ошибка квантования, вносимая АЦП. Если $G$~невелик,
    $n_B$~велико, часть
    членов можно опустить. По времени экспозиции:
    $$\mathrm{SNR}=Nt\cdot\bigl[Nt+n_{pix}(N_St+N_Dt+N^2_R)\bigr]^{-1/2},
    $$
    т.е. $\mathrm{SNR}\propto\sqrt{t}$. Для ярких источников $\mathrm{SNR}\propto\sqrt{Nt}$.
\end{block}
\end{frame}

\begin{frame}
\begin{block}{Первичная редукция}
\only<1>{
Итак, чтобы в нулевом приближении избавиться от влияния на сигнал оптической системы и ПЗС,
необходимо выполнить следующее:
$$S_0=\frac{S-D}{(F-D)_{norm}},$$
где $S$~-- object, $D$~-- dark, $F$~-- flat, $norm$~-- нормировка на единицу. В случае очень
больших экспозиций object (час и выше), невозможно получить хотя бы пару десятков кадров dark в тех
же условиях и до следующей ночи наблюдений. В этом случае используют т.н. superdark, $SD$~---
экстраполяцию линеаризованной МНК  зависимости $\{D(t)-B\}$, где $B$~-- bias:
$$S_0=\frac{S-B-SD\cdot t_S}{(F-D_F)_{norm}},$$
здесь, т.к. flat обычно имеет небольшую экспозицию, несложно накопить для них <<честные>> темновые.
}\only<2>{
Для каждой ночи наблюдений при коротких экспозициях <<научных кадров>> необходимо:
\begin{enumerate}
\item $30\div100$ dark frames;
\item $30\div100$ flatfields.
\end{enumerate}
В случе слишком длинных экспозиций, необходимо:
\begin{enumerate}
\item $10\div20$ bias frames;
\item не меньше 10 dark frames на каждую из минимум 10 экспозиций;
\item около 30 dark frames с экспозицией flatfield;
\item $30\div100$ flatfields.
\end{enumerate}
}
\end{block}
\end{frame}

\section{Получение характеристик ПЗС}
\begin{frame}{Получение характеристик ПЗС}
\begin{block}{}
\only<1>{
Обозначим gain как $G$. $N_\e=G\cdot S$. Выраженную в электронах, дисперсию полного шума <<плоского
поля>>, полученного в лаборатории на условно идеальном источнике освещения можно записать как
$$\sigma^2 = \sigma^2_\gamma + R^2 + \sigma^2_{CCD},$$
где $\sigma_\gamma$~-- фотонный шум, $R$~-- шум считывания, $\sigma_{CCD}$~-- прочие шумы ПЗС
(неоднородность чувствительности пикселей и т.п.). Избавиться от последнего члена мы можем,
используя разность двух изображений с одинаковыми экспозициями, но в этом случае полученную
дисперсию следует разделить на два. Данная операция поможет также избавиться от аддитивной добавки
к $S$, вызванной bias и темновым током.

Т.к. фотонный шум пропорционален корню из сигнала, в ADU получим:
$\sigma^2=S/G + R^2_{ADU}$. Выделим область в несколько десятков тысяч квадратных пикселей на
изображении в зоне, где уровень освещенности можно аппроксимировать горизонтальной плоскостью с
высокой точностью.
}\only<2>{
Получим:
$$\sigma^2 = \frac{\sum \bigl(S_1(x,y)-S_x(x,y)\bigr)^2}{2(N-1)},$$
где $N$~-- количество пикселей. Средний уровень обозначим как $S=(S_1+S_2)/2$.

Определение $\sigma^2$ и $\aver{S}$ необходимо провести для как можно большего значения разных
времен экспозиции.
Далее можно построить зависимость
$$\sigma^2 = S/G + R^2_{ADU},$$
линейно ее аппроксимировать к виду $\sigma^2=a\cdot S + b$ и получить значения $G=1/a$,
$R=G\cdot\sqrt{b}$.
}
\end{block}
\end{frame}

\section{Фотометрия}
\begin{frame}{Фотометрия}
\begin{columns}
\column{0.45\textwidth}
\begin{block}{Принципы фотометрии}
Распределение света от звезды между пикселями неоднородное, зашумленное.
Для измерения полного потока от звезды, необходимо:
\begin{itemize}
\item определить положение звезды на изображении;
\item при помощи маски выбрать те пиксели, которые принадлежат изображению именно этой звезды;
\item просуммировать сигнал за вычетом фона.
\end{itemize}
\end{block}
\column{0.45\textwidth}
\begin{block}{Центроид}
$$\mean{x}=\frac{\sum x_i I_i}{\sum I_i},\quad \mean{y}=\frac{\sum y_i I_i}{\sum I_i}, \quad
I_i = S_i - B.$$
\end{block}
\end{columns}
\end{frame}

\begin{frame}
\begin{block}{Апертурная фотометрия}
Проблема: определить радиусы апертур (звезды и фона).
\end{block}
\img[0.9]{apert}
\end{frame}

\begin{frame}
\begin{columns}
\column{0.45\textwidth}
\img{starphotom}
\column{0.52\textwidth}
\begin{block}{Модель апертурной фотометрии}
Параметры звезды: уровень сигнала, координаты центра, полуширина.

Параметры фона: средний уровень сигнала, $B$.

Параметры светоприемника: квантовая эффективность, шумы.

Радиусы апертур: $r_1$, $r_2$, $r_3$.
\end{block}
\end{columns}
\end{frame}

\begin{frame}
\begin{block}{Основные выражения}
$S = F+B+Q+E$, где $S$~-- накопленный сигнал, $F$~-- сигнал от звезды, $B$~-- фон, $Q$~-- темновой
ток, $E$~-- bias.

Суммарный сигнал от звезды: $F_\Sigma = \sum F_i=\sum(S_i-[B_i+Q_i+E_i])$.

Шум: $\sigma^2=F_\Sigma + N(\mean{B}+\mean{Q}+\sigma^2_{RO})+\sigma^2_{sky}$, $N$~-- количество
пикселей маски звезды, $\sigma^2_{RO}$~-- шум считывания. Первый член отражает зависимость
пуассоновского шума от уровня сигнала. $\sigma^2_{sky}=N(\mean{B}+\mean{Q}+\sigma^2_{RO})/N_{sky}$,
$N_{sky}$~-- количество пикселей в маске фона.

$\mathrm{SNR}=F_\Sigma/\sigma$. Чем слабее звезда, чем больше уровень фона, чем больше~$N$ и
меньше~$N_{sky}$, тем худшим будет SNR.
\end{block}
\end{frame}

\begin{frame}
\begin{columns}
\column{0.57\textwidth}
\img{starprofile}
\column{0.4\textwidth}
\begin{block}{Профили звезд}
Средний по изображению профиль позволяет оценить радиусы апертур. Также поможет при апертурной
коррекции.

Ошибка определения звездной величины: $\sigma_m=1.0857/\mathrm{SNR}$.
\end{block}
\end{columns}
\end{frame}

\section{Астрометрия}
\begin{frame}{Астрометрия}
\begin{columns}
\column{0.57\textwidth}
\img{diffastrometry}
\column{0.4\textwidth}
\begin{block}{}
Астрометрия позволяет измерить точные координаты звезд на небе, а также определить их параллаксы и
собственные движения. Первый каталог~--- Гиппарх, точность не выше~$1\degr$. Микросекундной
точности достиг запущенный в 1989\,г. космический телескоп HIPPARCOS.

Точность GAIA~--- $0.00002''$ ($20\mu as$)~--- толщина человеческого волоса с расстояния в 1000\,км!
\end{block}
\end{columns}
\end{frame}

\begin{frame}{}
\begin{block}{Каталоги}
\begin{enumerate}
\item \textbf{HIPPARCOS}~--- звезды до $m_V=7.3^m$, точность астрометрии до $1\div3\,$mas.
\item \textbf{TYCHO-2}~--- до $m_V=11^m$, точность $10\div100\,$mas.
\item \textbf{USNO B 1.0}~--- до $m_V=21^m$, фотометрический каталог с точностью до $0^m.3$.
\item \textbf{2MASS}~--- 470~миллионов объектов, точность до $70\,$mas.
\item \textbf{SDSS}~--- фотометрический каталог четверти неба в пяти фильтрах, 287~миллионов
объектов.
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{}
\vspace*{-1em}
\begin{columns}
\column{0.5\textwidth}
\img{WCSfits}
\column{0.48\textwidth}
\begin{block}{WCS}
WCS~--- World Coordinate System. ICRS~--- International Celestial Reference System (привязка к
барицентру Солнечной системы).
Ключевые слова WCS в FITS--шапке позволяют осуществить однозначную привязку пиксельных координат к
мировым (и обратно). Для линейных преобразований: \textbf{CTYPEi}~-- тип оси, \textbf{CRPIXi}~--
опорный пиксель (в пиксельных координатах), \textbf{CRVALi}~-- значение мировых координат в этом
пикселе (1~-- $\alpha$, 2~-- $\delta$), \textbf{CDi\_j}~-- матрица коэффициентов, описывающих
поворот осей и масштаб, \textbf{CUNITi}~-- единицы измерения по данной оси.
\end{block}
\end{columns}
\end{frame}

\begin{frame}{astrometry.net}
\img[0.6]{astrometrynet}
\end{frame}

\begin{frame}{Спасибо за внимание!}
\centering
\begin{minipage}{5cm}
\begin{block}{mailto}
eddy@sao.ru\\
edward.emelianoff@gmail.com
\end{block}\end{minipage}
\end{frame}
\end{document}
